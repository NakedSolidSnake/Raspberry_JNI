![JNI](https://miro.medium.com/max/782/1*9bdvQhEMjvymoIROt8yYXA.jpeg)
# _JNI_
## Introdução
## Implementação
### Java
#### Main.java
```java

public class Main {

	public static void main(String[] args) throws InterruptedException {

		JavaLED javaLED = new JavaLED();
		javaLED.initLED(0);

		JavaButton javaButton = new JavaButton(javaLED);
		javaButton.initButton(7);

		
		Thread threadButton = new Thread(javaButton);
		
		threadButton.start();
	}
}

```
#### JavaButton.java
```java

public class JavaButton implements Runnable{

	private int ledState;
	private JavaLED javaLED;

	public JavaButton(JavaLED javaLED){
		this.ledState = 0;
		this.javaLED = javaLED;
	}


	@Override
	public void run() {
		
		while(true) {
			if(ledState == 1)
				ledState = 0;
			else
				ledState = 1;
			
			readButton();
			javaLED.setLED(ledState);
			
		}		
	}
	
	native public void initButton(int pin);
	native public int readButton();

	static
    {
       System.loadLibrary("buttonnative");
    }
}

```
#### JavaLED.java
```java

public class JavaLED implements Runnable{

	@Override
	public void run() {
		while(true)
		{
			System.out.println("Thread LED");
			try {
				Thread.sleep(1000);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}		
	}
	
	native public void initLED(int pin);
	native public void setLED(int state);

	static
    {
       System.loadLibrary("lednative");
    }
}

```

### A Camada em C
#### JavaButton.h
```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class JavaButton */

#ifndef _Included_JavaButton
#define _Included_JavaButton
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     JavaButton
 * Method:    initButton
 * Signature: (I)V
 */
JNIEXPORT void JNICALL Java_JavaButton_initButton
  (JNIEnv *, jobject, jint);

/*
 * Class:     JavaButton
 * Method:    readButton
 * Signature: ()I
 */
JNIEXPORT jint JNICALL Java_JavaButton_readButton
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif

```
#### JavaButton.c
```c
#include "JavaButton.h"
#include <button.h>
#include <stdlib.h>
#include <unistd.h>

#define _1ms 1000

static Button_t button = {    
    .gpio.eMode = eModeInput,
    .ePullMode = ePullModePullUp,
    .eIntEdge = eIntEdgeFalling,
    .cb = NULL};

JNIEXPORT void JNICALL Java_JavaButton_initButton(JNIEnv *env, jobject object, jint pin)
{
    button.gpio.pin = pin;
    if (Button_init(&button))
       return;
}

JNIEXPORT jint JNICALL Java_JavaButton_readButton(JNIEnv *env, jobject object)
{
    while (1)
    {
        if (!Button_read(&button))
        {
            usleep(_1ms * 40);
            while (!Button_read(&button))
                ;
            usleep(_1ms * 40);
            break;
        }
        else
        {
            usleep(_1ms);
        }
    }
    return 0;
}
```

#### JavaLED.h
```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class JavaLED */

#ifndef _Included_JavaLED
#define _Included_JavaLED
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     JavaLED
 * Method:    initLED
 * Signature: (I)V
 */
JNIEXPORT void JNICALL Java_JavaLED_initLED
  (JNIEnv *, jobject, jint);

/*
 * Class:     JavaLED
 * Method:    setLED
 * Signature: (I)V
 */
JNIEXPORT void JNICALL Java_JavaLED_setLED
  (JNIEnv *, jobject, jint);

#ifdef __cplusplus
}
#endif
#endif

```
#### JavaLED.c
```c
#include "JavaLED.h"
#include <led.h>

static LED_t led =
{        
    .gpio.eMode = eModeOutput
};

JNIEXPORT void JNICALL Java_JavaLED_initLED(JNIEnv *env, jobject object, jint pin)
{
    led.gpio.pin = pin;
    if (LED_init(&led))
        return;
}

JNIEXPORT void JNICALL Java_JavaLED_setLED(JNIEnv *env, jobject object, jint state)
{
    LED_set(&led, (eState_t)state);
}
```

## Compilação
### build.xml
```java
<project name="Example" default="All">
	<target name="Clean">
		<delete dir="build"/>		
        <delete file="c_code/include/*.h"/>
	</target>
	<target name="Compiling" depends="Clean">		
        <mkdir dir="build"/>
		<javac srcdir="src" destdir="build" nativeHeaderDir="c_code/include">			
		</javac>
    </target>

    <target name="Generate-Shared-Library" depends="Compiling">
        <exec executable="/usr/bin/make" dir="c_code">  
            <arg value="all"/>      
        </exec>
    </target>

    <target name="All" depends="Compiling, Generate-Shared-Library">
    </target>	
</project>
```

### Makefile
```c
all:
	gcc -fPIC -I/usr/lib/jvm/jdk-8-oracle-arm32-vfp-hflt/include -I/usr/lib/jvm/jdk-8-oracle-arm32-vfp-hflt/include/linux -I./include -c src/JavaButton.c -o src/JavaButton.o
	gcc -shared -o libbuttonnative.so src/JavaButton.o -lhardware
	mv libbuttonnative.so ../build
	mv src/JavaButton.o ../build

	gcc -fPIC -I/usr/lib/jvm/jdk-8-oracle-arm32-vfp-hflt/include -I/usr/lib/jvm/jdk-8-oracle-arm32-vfp-hflt/include/linux -I./include -c src/JavaLED.c -o src/JavaLED.o
	gcc -shared -o liblednative.so src/JavaLED.o -lhardware
	mv liblednative.so ../build
	mv src/JavaLED.o ../build
```

## Conclusão
